
var time = ["[00:00.79]", "[00:02.84]", "[00:04.50]", "[00:06.43]", "[00:37.85]", "[00:40.13]", "[00:42.31]", "[00:44.34]", "[00:49.85]", "[00:52.64]", "[00:54.94]", "[00:56.80]", "[00:59.11]", "[01:01.37]", "[01:02.17]", "[01:04.23]", "[01:06.50]", "[01:10.13]", "[01:13.83]", "[01:19.67]", "[01:21.22]", "[01:24.16]", "[01:28.60]", "[01:31.85]", "[01:33.69]", "[01:36.91]", "[01:39.20]", "[01:41.10]", "[01:43.63]", "[01:46.57]", "[01:48.85]", "[01:51.69]", "[01:54.01]", "[01:56.17]", "[01:58.12]", "[01:59.55]", "[02:00.91]", "[02:03.32]", "[02:35.07]", "[02:38.79]", "[02:42.47]", "[02:48.34]", "[02:49.83]", "[02:52.78]", "[02:57.21]", "[02:59.94]", "[03:00.49]", "[03:02.21]", "[03:04.61]", "[03:08.33]", "[03:11.98]", "[03:17.95]", "[03:19.38]", "[03:23.05]", "[03:26.75]", "[03:29.03]", "[03:30.45]"];
var txt = ["安和桥 - 宇西", "词：宋冬野", "曲：宋冬野", "", "让我再看你一遍", "从南到北", "", "像是被五环路蒙住的双眼", "", "请你再讲一遍", "关于那天", "", "抱着盒子的姑娘", "", "和擦汗的男人", "", "我知道 那些夏天", "就像青春一样回不来", "代替梦想的也只能是勉为其难", "", "我知道 吹过的牛逼", "也会随青春一笑了之", "让我困在城市里", "纪念你", "", "让我再尝一口", "秋天的酒", "", "一直往南方开", "不会太久", "", "让我再听一遍", "最美的那一句", "", "你回家了", "", "我在等你呢", "", "我知道 那些夏天", "就像青春一样回不来", "代替梦想的也只能是勉为其难", "", "我知道 吹过的牛逼", "也会随青春一笑了之", "让我困在城市里", "", "纪念你", "", "我知道 那些夏天", "就像你一样回不来", "我也不会再对谁满怀期待", "", "我知道 这个世界", "每天都有太多遗憾", "所以你好", "", "再见"];

var time2 = ["[00:00.27]", "[00:01.59]", "[00:02.48]", "[00:03.52]", "[00:17.33]", "[00:20.90]", "[00:24.29]", "[00:27.54]", "[00:29.18]", "[00:34.07]", "[00:36.30]", "[00:41.44]", "[00:43.56]", "[00:45.17]", "[00:46.48]", "[00:49.35]", "[00:50.05]", "[00:53.55]", "[00:54.10]", "[00:56.29]", "[00:59.73]", "[01:00.74]", "[01:02.50]", "[01:04.27]", "[01:07.70]", "[01:08.20]", "[01:10.04]", "[01:14.00]", "[01:14.88]", "[01:17.67]", "[01:18.42]", "[01:21.86]", "[01:22.49]", "[01:24.67]", "[01:27.99]", "[01:29.15]", "[01:31.00]", "[01:32.74]", "[01:36.68]", "[01:38.47]", "[01:42.62]", "[01:46.37]", "[01:49.71]", "[01:53.38]", "[01:56.69]", "[01:58.08]", "[02:03.31]", "[02:05.16]", "[02:10.90]", "[02:11.88]", "[02:14.51]", "[02:15.39]", "[02:18.07]", "[02:18.91]", "[02:22.39]", "[02:22.94]", "[02:25.17]", "[02:28.34]", "[02:29.62]", "[02:31.43]", "[02:33.16]", "[02:36.59]", "[02:37.13]", "[02:38.89]", "[02:42.94]", "[02:43.81]", "[02:46.47]", "[02:47.35]", "[02:50.78]", "[02:51.36]", "[02:53.61]", "[02:56.62]", "[02:58.05]", "[02:59.95]", "[03:01.65]", "[03:05.00]", "[03:05.60]", "[03:07.44]", "[03:11.59]", "[03:24.07]", "[03:26.60]", "[03:27.45]", "[03:30.22]", "[03:30.96]", "[03:35.51]", "[03:38.97]", "[03:41.64]", "[03:42.49]", "[03:45.98]", "[03:46.57]", "[03:48.77]", "[03:52.38]", "[03:53.23]", "[03:55.02]", "[03:56.75]", "[04:00.15]", "[04:00.74]", "[04:02.60]", "[04:06.08]", "[04:07.47]","[04:09.21]","[04:10.95]","[04:14.35]","[04:14.97]","[04:16.71]"];
var txt2 = ["修炼爱情 - 宇西", "词：易家扬", "曲：林俊杰", "", "凭什么要失望", "", "藏眼泪到心脏", "", "往事不会说谎别跟它为难", "", "我们两人之间不需要这样", "", "我想", "", "修炼爱情的心酸", "", "学会放好以前的渴望", "", "我们那些信仰", "要忘记多难", "", "远距离的欣赏", "近距离的迷惘", "谁说太阳会找到月亮", "", "别人有的爱", "我们不可能模仿", "", "修炼爱情的悲欢", "", "我们这些努力不简单", "", "快乐炼成泪水", "是一种勇敢", "", "几年前的幻想", "几年后的原谅", "为一张脸去养一身伤", "别讲想念我", "我会受不了这样", "", "记忆它真嚣张", "", "路灯把痛点亮", "", "情人一起看过多少次月亮", "", "它在天空看过多少次遗忘", "", "多少心慌", "", "修炼爱情的心酸", "", "学会放好以前的渴望", "", "我们那些信仰", "要忘记多难", "", "远距离的欣赏", "近距离的迷惘", "谁说太阳会找到月亮", "", "别人有的爱", "我们不可能模仿", "", "修炼爱情的悲欢", "", "我们这些努力不简单", "", "快乐炼成泪水", "是一种勇敢", "", "几年前的幻想", "几年后的原谅", "为一张脸去养一身伤", "", "别讲想念我", "我会受不了这样", "", "笑着说爱让人疯狂", "", "哭着说爱让人紧张", "", "忘不了那个人就投降", "", "修炼爱情的悲欢", "", "我们这些努力不简单", "", "快乐炼成泪水", "是一种勇敢", "", "几年前的幻想", "几年后的原谅", "为一张脸去养一身伤", "", "别讲想念我", "我会受不了这样", "", "几年前的幻想","几年后的原谅","为一张脸去养一身伤","别讲想念我","我会受不了这样"];

var time3 = ["[00:00.86]", "[00:02.14]", "[00:03.30]", "[00:04.55]", "[00:18.89]", "[00:21.90]", "[00:25.11]", "[00:28.30]", "[00:31.04]", "[00:31.56]", "[00:34.76]", "[00:38.10]", "[00:41.26]", "[00:43.92]", "[00:44.63]", "[00:47.80]", "[00:51.04]", "[00:54.24]", "[00:56.89]", "[00:57.49]", "[01:00.70]", "[01:04.03]", "[01:07.25]", "[01:09.70]", "[01:13.10]", "[01:14.67]", "[01:17.67]", "[01:22.90]", "[01:26.02]", "[01:27.64]", "[01:30.59]", "[01:37.15]", "[01:46.58]", "[01:49.23]", "[01:52.55]", "[01:55.67]", "[01:58.16]", "[01:59.15]", "[02:02.25]", "[02:05.58]", "[02:08.75]", "[02:11.23]", "[02:12.11]", "[02:15.19]", "[02:18.48]", "[02:21.65]", "[02:24.33]", "[02:25.05]", "[02:28.19]", "[02:31.51]", "[02:34.71]", "[02:36.74]", "[02:37.28]", "[02:40.52]", "[02:42.11]", "[02:45.24]", "[02:50.45]", "[02:53.52]", "[02:55.07]", "[02:58.03]", "[03:03.82]", "[03:26.88]", "[03:29.15]", "[03:30.80]", "[03:33.89]", "[03:38.73]", "[03:42.07]", "[03:43.66]", "[03:46.72]", "[03:52.57]", "[03:53.63]"];
var txt3 = ["年轮 - 宇西", "词：汪苏泷", "曲：汪苏泷", "", "圆圈勾勒成指纹", "印在我的嘴唇", "回忆苦涩的吻痕", "是树根", "", "春去秋来的茂盛", "却遮住了黄昏", "寒夜剩我一个人", "等清晨", "", "世间最毒的仇恨", "是有缘却无分", "可惜你从未心疼", "我的笨", "", "荒草丛生的青春", "倒也过的安稳", "代替你陪着我的", "是年轮", "数着一圈圈年轮", "我认真", "将心事都封存", "密密麻麻是我的自尊", "修改一次次离分", "我承认", "曾幻想过永恒", "可惜从没人陪我演这剧本", "", "圆圈勾勒成指纹", "印在我的嘴唇", "回忆苦涩的吻痕", "是树根", "", "春去秋来的茂盛", "却遮住了黄昏", "寒夜剩我一个人", "等清晨", "", "世间最毒的仇恨", "是有缘却无分", "可惜你从未心疼", "我的笨", "", "荒草丛生的青春", "倒也过的安稳", "代替你陪着我的", "是年轮", "", "数着一圈圈年轮", "我认真", "将心事都封存", "密密麻麻是我的自尊", "修改一次次离分", "我承认", "曾幻想过永恒", "可惜从没人陪我演这剧本", "", "一圈圈年轮", "我认真", "将心事都封存", "密密麻麻是我的自尊", "修改一次次离分", "我承认", "曾幻想过永恒", "可惜从没人陪我演这剧本", "", "可惜从没人陪我演这剧本"];

var time4 = ["[00:01.03]", "[00:02.81]", "[00:03.95]", "[00:05.25]", "[00:23.24]", "[00:25.75]", "[00:28.58]", "[00:32.00]", "[00:33.78]", "[00:36.47]", "[00:39.54]", "[00:42.17]", "[00:43.62]", "[00:46.11]", "[00:48.85]", "[00:51.43]", "[00:54.13]", "[00:56.80]", "[00:59.49]", "[01:03.95]", "[01:04.68]", "[01:10.70]", "[01:14.55]", "[01:15.23]", "[01:21.31]", "[01:25.50]", "[01:48.66]", "[01:51.11]", "[01:53.90]", "[01:57.36]", "[01:59.13]", "[02:01.72]", "[02:04.51]", "[02:07.45]", "[02:08.96]", "[02:11.35]", "[02:14.11]", "[02:16.74]", "[02:19.45]", "[02:22.12]", "[02:24.77]", "[02:29.25]", "[02:29.95]", "[02:35.94]", "[02:39.87]", "[02:40.60]", "[02:46.81]", "[02:50.56]", "[02:51.32]", "[02:57.54]", "[03:01.38]", "[03:02.51]", "[03:08.01]", "[03:11.95]", "[03:12.71]", "[03:18.83]"];
var txt4 = ["告白气球 - 宇西", "词：方文山", "曲：周杰伦", "", "塞纳河畔左岸的咖啡", "我手一杯品尝你的美", "留下唇印的嘴", "", "花店玫瑰名字写错谁", "告白气球风吹到对街", "微笑在天上飞", "", "你说你有点难追", "想让我知难而退", "礼物不需挑最贵", "只要香榭的落叶", "营造浪漫的约会", "不害怕搞砸一切", "拥有你就拥有全世界", "", "亲爱的爱上你从那天起", "甜蜜的很轻易", "", "亲爱的别任性你的眼睛", "在说我愿意", "", "塞纳河畔左岸的咖啡", "我手一杯品尝你的美", "留下唇印的嘴", "", "花店玫瑰名字写错谁", "告白气球风吹到对街", "微笑在天上飞", "", "你说你有点难追", "想让我知难而退", "礼物不需挑最贵", "只要香榭的落叶", "营造浪漫的约会", "不害怕搞砸一切", "拥有你就拥有全世界", "", "亲爱的爱上你从那天起", "甜蜜的很轻易", "", "亲爱的别任性你的眼睛", "在说我愿意", "", "亲爱的爱上你恋爱日记", "飘香水的回忆", "", "一整瓶的梦境全都有你", "搅拌在一起", "", "亲爱的别任性你的眼睛", "在说我愿意"];

var song_data = {
		song: [{'time': time, 'song': txt, 'path': '../images/hotsongs11.jpg', 'name': '安和桥',
				'author': '宇西', 'url':'../music/anheqiao.mp3'},
			   {'time': time2, 'song': txt2, 'path': '../images/hot10.jpg','name':
			   '修炼爱情', 'author': '宇西', 'url':'../music/xiulianaiqing.mp3'},
			   {'time': time3, 'song': txt3, 'path': '../images/content4.jpg','name':
			   '年轮', 'author': '宇西', 'url':'../music/nianlun.mp3'},
			   {'time': time4, 'song': txt4, 'path': '../images/content7.jpg','name':
			   '告白气球', 'author': '宇西', 'url':'../music/gaobaiqiqiu.mp3'}]
}

;$(function(){
	var initTop = px2rem(30),  //歌词初始top
		start = 1,		//数组初始值
		listIndex = 0,  //歌曲列表
		currentSong = null,//当前歌曲
		currentSinger = null,//当前歌手
		duration = 0,	//音频时长
		audio = $('audio').get(0), //音频
		progresslength = $('.progress').width();//播放条长度

	function px2rem(px){
		return px/36;
	}

	//设置播放器的位置及高度
	var rwidth = $('.play-rotate').width();
	$('.play-rotate').css({
		'height': rwidth,
		'marginLeft': -(rwidth / 2)
	})
	// 图片,歌曲,作者,歌词,初始化
	initImg(song_data.song[0].path,song_data.song[0].name);
	// 创建歌词p元素
	initSong(song_data.song[0].song);

	// ---------逻辑代码-----------
	
	// 播放按钮点击事件
	$('#toggle-play').tap(function(){

		// 设置滚动title
		setTitle(listIndex)
		// $(this).toggleClass('active');
		$('.play-rotate').hasClass('animation') == false && $('.play-rotate').addClass('animation');
		// 播放按钮重置
		 $('.head i').toggleClass('paused').toggleClass('active');
		// 播放时间重置
		if($('.currentPro').width() == progresslength){
			initProgress();
		}
		// 播放状态
		if($(this).hasClass('active')){
			setPlay(audio)
		}else{ //暂停状态
			audio.pause();
			setEnd();
		}
	})
	
	// 播放模式
	var tapTime = 0;
	$('#play-method').tap(function(){
		tapTime++;
		console.log(tapTime)
		switch(tapTime){
			case 1 :
				$(this).attr('class','loop');
			break;
			case 2 :
				$(this).attr('class','single-play');
			break;
			case 3 :
				$(this).attr('class','random');
			break;
			default:
				$(this).attr('class','order');
				tapTime = 0;
			break;

		}
	})

		// 时间初始化
	audio.oncanplay = function(){
		setSongTime(this.duration);
	}

	
	// 音频播放时触发
	audio.ontimeupdate = function() {
		playUpdate(this,time,this.duration);
	};

	// 音频停止事件
	audio.onended = function(){

		setEnd();

		playWithMethod();
	
	}
	// 判断播放方式
	function playWithMethod(){
		var getMethod = $('#play-method').attr('class');
		start = 1;
		initTop = px2rem(30);
		switch (getMethod){
			case 'order':
				if(listIndex == 3){
					return;
				}
				listIndex++;
				changeSong();
				break;
			case 'random':
				listIndex = getRandNum(song_data.song.length,listIndex); //简单产生随机数
				console.log(listIndex)
				changeSong();
				break;
			case 'loop':
				if(listIndex == 3){
					listIndex = -1;
				}
				listIndex++;
				changeSong();
				break;
			case 'single-play':
				// 重新播放
				console.log('单曲循环');

				changeSong();
				break;
		}
	}
	

	// 下一首
	$('.next-song').tap(function(){
		
		listIndex === 3 && (listIndex = -1);
		if($('#play-method').attr('class') === 'single-play'){
			listIndex++;
			changeSong()
		}else{
			playWithMethod();
		}
		initSongList(listIndex);
	})
	// 上一首
	$('.pre-song').tap(function(){
	
		listIndex === 0 && (listIndex = song_data.song.length);
		if($('#play-method').attr('class') === 'single-play'){
			listIndex--;
			changeSong()
		}else{
			listIndex -= 2;
			playWithMethod();
		}
		initSongList(listIndex);
	})

	// 切换歌曲
	function changeSong(){

		// $('.play-rotate').css('transition','none').css({
		// 	'transform':'rotateY(180deg)',
		// 	// 'transition':'all 2s'
		// })
		// audio 原文件
		$('audio').remove();
		$('body').append($('<audio class="nextAudio"><source src="'+ song_data.song[listIndex].url +'"/></audio>'));
		$('.song-box p').remove();

		// 创建歌词p元素
		initSong(song_data.song[listIndex].song);
		// 设置浏览器title
		setTitle(listIndex);
		audio = $('.nextAudio').get(0);
		console.log(audio)
		audio.oncanplay = function(){

			// setPaused(this);
			duration = audio.duration;
			setSongTime(duration);
			//初始图片，歌词作者信息 
			initImg(song_data.song[listIndex].path,song_data.song[listIndex].name);
			// 进度条
			initProgress();

			setPlay(this);

			// 播放按钮样式
			 $('.head i').removeClass('paused').addClass('active');
			// $('#toggle-play').css('backgroundPosition', '16px 532px');
		}
		audio.ontimeupdate = function (){
			playUpdate(this,song_data.song[listIndex].time,duration);	
		}
		audio.onended = function(){
			setEnd();
			playWithMethod();
		}
	}


	// 点击列表之外区域隐藏
	$('#singer').tap(function(e){
		e.stopPropagation();
		$('.song-list').removeClass('list-hide');
		initSongList(listIndex)
	})
	// 点击列表选歌
	$('.song-list li').tap(function(e){
		e.stopPropagation();
		$('.song-list').addClass('list-hide');
		listIndex = $(this).index();
		initSongList(listIndex);
		changeSong();
		return;
	})
	$(document).tap(function(){
		if(!$('.song-list').hasClass('list-hide')){
			$('#toggle-play').next().addClass('list-hide')
		}
	})

	
	// 初始化结构--歌词
	function initSong(songData){
		// 创建歌词p元素
		$.each(songData,function(index,item){
			item == '' ? $('.song-box').append($('<p>.<p>')) : $('.song-box').append($('<p>'+item+'<p>'));
		});

		$('.song-box p').each(function(index,item){
			item.innerHTML == '' && $(this).remove();
		})
	}

	// 设置滚动title
	function setTitle(listIndex){
		currentSong = song_data.song[listIndex].name;
		currentSinger = song_data.song[listIndex].author;
		document.title = '…正在播放 ' + currentSong + '-' + currentSinger;
		setInterval(function(){
			var arr = Array.from(document.title);
			arr.push(arr.shift())
			document.title = arr.join('');
		},750)
	}

	// 图片,歌曲,作者,歌词,初始化
	function initImg(url,name){
		
		currentSong = song_data.song[listIndex].name;
		currentSinger = song_data.song[listIndex].author;
		$('.head-info h2').text(name);
		$('#singer').attr('src',url);
		$('.bg-box img').attr('src',url);
		$('.play-rotate').css('backgroundImage','url('+ url +')');
		$('.song-box').css('top', px2rem(20)+'rem');

	}
	// 进度条,起始时间初始化
	function initProgress(){
		$('.startMinute').text('00');
		$('.startSecond').text('00');
		// 初始化歌词样式
		$('.song-box p').hasClass('old') && $('.song-box p').removeClass('old');
		$('.song-box p').hasClass('current') && $('.song-box p').removeClass('current');
		// 进度条
		$('.currentPro').css('width','0px');
		//歌词位置 
		$('.song-box').css('top', px2rem(20)+'rem');
	}

	// 歌曲播放状态
	function setPlay(audio){
		audio.play();
		$('.play-rotate').css('animationPlayState','running');

	}
	// 歌曲暂停状态
	function setPaused(audio){
		audio.pause();
		$('#toggle-play').removeClass('active');
		$('.play-rotate').css('animationPlayState','paused');
		 $('.head i').removeClass('active').addClass('paused');
	}
	
	function setEnd(){
		// 播放按钮
		$('#toggle-play').removeClass('active');
		// 播放按钮重置
		 $('.head i').removeClass('active').addClass('paused');
		// 暂停旋转
		$('.play-rotate').css('animationPlayState','paused');
	}

	// 设置歌曲列表样式
	function initSongList(listIndex){
		$('.list-song').removeClass('playing').eq(listIndex).addClass('playing');
		$('.list-song s.gif').hide().eq(listIndex).show();
	}

	/*
		格式化并设置歌曲结束的时间

	*/
	function setSongTime(duration){
		var duration = Math.round(duration);
		var minute = parseInt(duration / 60);
		minute = minute >= 10 ? minute : '0'+ minute;
		// 秒
		var second = parseInt(duration % 60 );
		second = second >= 10 ? second : '0'+ second;

		$('.endMinute').text(minute);
		$('.endSecond').text(second);
	}

	/*
	播放时间
	obj：audio对象
	songData：歌词数组
	duration：歌曲时长
	*/
	function playUpdate (obj,songData,duration){

		var current = initTime = obj.currentTime.toFixed(0);
		// 播放时间
		var initM = parseInt(initTime / 60);
		var initS = initTime % 60;
		initM = initM >= 10 ? initM : '0' + initM;
		initS = initS >= 10 ? initS : '0' + initS;
		$('.startMinute').text(initM);
		$('.startSecond').text(initS);

		

		// 进度条长度
		var currentLength = progresslength * current / duration;	

		$('.currentPro').css('width',currentLength)

		// 歌词样式
		$('.song-box p').eq(start-1).addClass('current').siblings().removeClass('current');
		start-2 >= 0 && $('.song-box p').eq(start-2).addClass('old');
		while(songData[start] && current == normalize(songData[start]) ){
			initTop  -= px2rem(20) ;
			$('.song-box').animate({
				'top': initTop+'rem'
			});
			start++;
		}
	}
	
	/*
	格式化时间
	time ：后台传到前台歌词时间
	*/
	function normalize(time){
		var timeArr = time.substr(1,time.length-2).split(':');
		// 整秒数
		var second = parseInt(timeArr[0]);
		var floatTime = parseFloat(timeArr[1]);
		var normalize = second * 60 + floatTime;
		// 四舍五入不保留小数
		return normalize.toFixed(0)
	}

	// 获取随机数
	function getRandNum(length,listIndex){
		var random = parseInt(Math.random()*length);
		while(random == listIndex){
			random = parseInt(Math.random()*length)
		}
		return random;
	}

})
